<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - SutrAlgo</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;500;600;700;800;900&family=Work+Sans:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Performance & Optimization -->
    <script src="/js/admin-performance.js"></script>
    <script src="/js/admin-virtual-scroll.js"></script>
    <!-- Advanced Features -->
    <script src="/js/admin-rbac.js"></script>
    <script src="/js/admin-2fa.js"></script>
    <script src="/js/admin-query-builder.js"></script>
    <script src="/js/admin-schema-viewer.js"></script>
    <script src="/js/admin-communication-hub.js"></script>
    <!-- Core Components -->
    <script src="/js/admin-components.js"></script>
    <script src="/js/admin-components-v2.js"></script>
    <script src="/js/admin-charts-v2.js"></script>
    <script src="/js/admin-tables-v2.js"></script>
    <script src="/js/admin-user-management-v2.js"></script>
    <script src="/js/admin-analytics-v2.js"></script>
    <script src="/js/admin-dashboard.js"></script>
    <script src="/js/admin-users.js"></script>
    <script src="/js/admin-subscriptions.js"></script>
    <script src="/js/admin-payments.js"></script>
    <script src="/js/admin-audit.js"></script>
    <script src="/js/admin-analytics.js"></script>
    <script src="/js/admin-database.js"></script>
    <script src="/js/admin-settings.js"></script>
    <script src="/js/admin-signal-testing.js"></script>
    <!-- Modern CSS -->
    <link rel="stylesheet" href="/css/main.css">

    <!-- Modern Effects (Custom Cursor, Scroll Progress, Animations) -->
    <script src="/js/modern-effects.js" defer></script>

</head>
<body class="admin-portal">
    <!-- Alert Container -->
    <div id="alert-container" class="alert-container"></div>

    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Toggle menu">
        <span class="hamburger-icon"></span>
    </button>

    <!-- Main Container -->
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="admin-sidebar" id="admin-sidebar">
            <div class="sidebar-header">
                <a href="/admin-v2" class="admin-logo">‚ö° SutrAlgo</a>
                <button class="sidebar-close" id="sidebar-close" aria-label="Close menu">&times;</button>
            </div>

            <nav>
                <ul class="admin-nav">
                    <li class="admin-nav-item">
                        <a href="#dashboard" class="admin-nav-link active" data-page="dashboard">
                            <span class="admin-nav-icon">üìä</span>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="#users" class="admin-nav-link" data-page="users">
                            <span class="admin-nav-icon">üë•</span>
                            <span>Users</span>
                        </a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="#subscriptions" class="admin-nav-link" data-page="subscriptions">
                            <span class="admin-nav-icon">üí≥</span>
                            <span>Subscriptions</span>
                        </a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="#payments" class="admin-nav-link" data-page="payments">
                            <span class="admin-nav-icon">üí∞</span>
                            <span>Payments</span>
                        </a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="#audit" class="admin-nav-link" data-page="audit">
                            <span class="admin-nav-icon">üìã</span>
                            <span>Audit Log</span>
                        </a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="#analytics" class="admin-nav-link" data-page="analytics">
                            <span class="admin-nav-icon">üìà</span>
                            <span>Analytics</span>
                        </a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="#database" class="admin-nav-link" data-page="database">
                            <span class="admin-nav-icon">üóÑÔ∏è</span>
                            <span>Database</span>
                        </a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="#settings" class="admin-nav-link" data-page="settings">
                            <span class="admin-nav-icon">‚öôÔ∏è</span>
                            <span>Settings</span>
                        </a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="#signal-testing" class="admin-nav-link" data-page="signal-testing">
                            <span class="admin-nav-icon">üß™</span>
                            <span>Signal Testing</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-content">
            <!-- Header -->
            <header class="admin-header">
                <div class="admin-header-content">
                    <h1 class="admin-header-title" id="page-title">Dashboard</h1>
                    <div class="admin-header-actions">
                        <button class="btn btn-secondary btn-sm" id="dark-mode-toggle" title="Toggle Dark Mode">
                            üåô Dark Mode
                        </button>
                        <div class="status-indicator">
                            <span class="status-dot status-success"></span>
                            <span class="status-text">System Online</span>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="window.location.href='/'">
                            ‚Üê Back to App
                        </button>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div id="page-content">
                <!-- Dashboard Page (Default) -->
                <div id="dashboard-page" class="page-section active">
                    <!-- Key Metrics -->
                    <div class="metrics-grid" id="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-icon">üìä</div>
                            <div class="metric-content">
                                <div class="metric-title">Monthly Recurring Revenue</div>
                                <div class="metric-value" id="metric-mrr">Loading...</div>
                                <div class="metric-change metric-change-positive" id="metric-mrr-change"></div>
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon">üë•</div>
                            <div class="metric-content">
                                <div class="metric-title">Total Users</div>
                                <div class="metric-value" id="metric-users">Loading...</div>
                                <div class="metric-change metric-change-positive" id="metric-users-change"></div>
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon">üí≥</div>
                            <div class="metric-content">
                                <div class="metric-title">Active Subscriptions</div>
                                <div class="metric-value" id="metric-subs">Loading...</div>
                                <div class="metric-change metric-change-positive" id="metric-subs-change"></div>
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon">üí∞</div>
                            <div class="metric-content">
                                <div class="metric-title">Payments This Month</div>
                                <div class="metric-value" id="metric-payments">Loading...</div>
                                <div class="metric-change metric-change-positive" id="metric-payments-change"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Revenue Trend Chart -->
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <h2 class="admin-card-title">Revenue Trend (Last 12 Months)</h2>
                            <div>
                                <button class="btn btn-secondary btn-sm" onclick="AdminDashboard.changeChartPeriod('month')">Month</button>
                                <button class="btn btn-secondary btn-sm" onclick="AdminDashboard.changeChartPeriod('year')">Year</button>
                            </div>
                        </div>
                        <div class="admin-card-body">
                            <canvas id="revenue-chart" height="80"></canvas>
                        </div>
                    </div>

                    <!-- Recent Activity & Quick Actions -->
                    <div>
                        <!-- Recent Activity -->
                        <div class="admin-card">
                            <div class="admin-card-header">
                                <h2 class="admin-card-title">Recent Activity</h2>
                                <button class="btn btn-secondary btn-sm" onclick="loadPage('audit')">View All</button>
                            </div>
                            <div class="admin-card-body">
                                <div class="activity-feed" id="recent-activity">
                                    <div class="spinner-container spinner-medium">
                                        <div class="spinner"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="admin-card">
                            <div class="admin-card-header">
                                <h2 class="admin-card-title">Quick Actions</h2>
                            </div>
                            <div class="admin-card-body">
                                <div>
                                    <button class="btn btn-primary" onclick="loadPage('users')">
                                        üë• Manage Users
                                    </button>
                                    <button class="btn btn-primary" onclick="loadPage('subscriptions')">
                                        üí≥ View Subscriptions
                                    </button>
                                    <button class="btn btn-primary" onclick="loadPage('payments')">
                                        üí∞ Check Payments
                                    </button>
                                    <button class="btn btn-secondary" onclick="runManualScan()">
                                        üîç Run Stock Scanner
                                    </button>
                                    <button class="btn btn-secondary" onclick="loadPage('database')">
                                        üóÑÔ∏è Database Tools
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other pages will be loaded dynamically -->
                <div id="users-page" class="page-section"></div>
                <div id="subscriptions-page" class="page-section"></div>
                <div id="payments-page" class="page-section"></div>
                <div id="audit-page" class="page-section"></div>
                <div id="analytics-page" class="page-section"></div>
                <div id="database-page" class="page-section"></div>
                <div id="settings-page" class="page-section"></div>
                <div id="signal-testing-page" class="page-section"></div>
            </div>
        </main>
    </div>

    <script>
        // Page Navigation
        function loadPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page-section').forEach(page => {
                page.style.display = 'none';
            });

            // Remove active class from all nav links
            document.querySelectorAll('.admin-nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Show selected page
            const pageElement = document.getElementById(`${pageName}-page`);
            if (pageElement) {
                pageElement.style.display = 'block';
            }

            // Activate nav link
            const navLink = document.querySelector(`[data-page="${pageName}"]`);
            if (navLink) {
                navLink.classList.add('active');
            }

            // Update page title
            const titles = {
                dashboard: 'Dashboard',
                users: 'User Management',
                subscriptions: 'Subscription Management',
                payments: 'Payment Management',
                audit: 'Audit Log',
                analytics: 'Analytics & Reports',
                database: 'Database Tools',
                settings: 'System Settings',
                'signal-testing': 'Signal Testing & Diagnostics'
            };

            document.getElementById('page-title').textContent = titles[pageName] || pageName;

            // Load page content
            loadPageContent(pageName);

            // Update URL hash
            window.location.hash = pageName;
        }

        // Load page content
        async function loadPageContent(pageName) {
            // Cleanup previous page components before loading new page
            if (typeof AdminDashboard !== 'undefined' && AdminDashboard.cleanup) {
                AdminDashboard.cleanup();
            }

            switch(pageName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'subscriptions':
                    loadSubscriptions();
                    break;
                case 'payments':
                    loadPayments();
                    break;
                case 'audit':
                    loadAuditLog();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
                case 'database':
                    loadDatabase();
                    break;
                case 'settings':
                    loadSettings();
                    break;
                case 'signal-testing':
                    loadSignalTesting();
                    break;
            }
        }

        // Load Dashboard
        async function loadDashboard() {
            // Initialize dashboard with all components
            await AdminDashboard.init();
        }

        // Load Users
        async function loadUsers() {
            await AdminUsers.init();
        }

        // Load Subscriptions
        async function loadSubscriptions() {
            await AdminSubscriptions.init();
        }

        // Load Payments
        async function loadPayments() {
            await AdminPayments.init();
        }

        // Load Audit Log
        async function loadAuditLog() {
            await AdminAudit.init();
        }

        // Load Analytics
        async function loadAnalytics() {
            await AdminAnalytics.init();
        }

        // Load Database
        async function loadDatabase() {
            await AdminDatabase.init();
        }

        // Load Settings
        async function loadSettings() {
            await AdminSettings.init();
        }

        // Load Signal Testing
        async function loadSignalTesting() {
            await AdminSignalTesting.init();
        }

        // Run Manual Scan
        async function runManualScan() {
            AdminComponents.alert({
                type: 'info',
                message: 'Starting stock scanner...',
                autoDismiss: 3000
            });

            try {
                const response = await fetch('/api/admin/trigger-scan', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    AdminComponents.alert({
                        type: 'success',
                        message: 'Stock scanner started successfully!',
                        autoDismiss: 5000
                    });
                } else {
                    throw new Error(data.error || 'Failed to start scanner');
                }
            } catch (error) {
                AdminComponents.alert({
                    type: 'error',
                    message: `Failed to start scanner: ${error.message}`,
                    autoDismiss: 5000
                });
            }
        }

        // Navigation click handlers
        document.querySelectorAll('.admin-nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageName = link.getAttribute('data-page');
                loadPage(pageName);
            });
        });

        // Handle hash changes
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.substring(1);
            if (hash) {
                loadPage(hash);
            }
        });

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash.substring(1);
            loadPage(hash || 'dashboard');
        });

        // Setup SSE for real-time updates
        function setupSSE() {
            const eventSource = new EventSource('/api/admin/events');

            eventSource.addEventListener('activity', (event) => {
                const data = JSON.parse(event.data);
                loadRecentActivity();
            });

            eventSource.addEventListener('metrics', (event) => {
                const data = JSON.parse(event.data);
                // Update metrics
            });

            eventSource.onerror = (error) => {
                console.error('SSE connection error:', error);
                eventSource.close();
            };
        }

        // setupSSE(); // Uncomment when SSE endpoint is ready

        // Mobile Menu Functionality
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const sidebar = document.getElementById('admin-sidebar');
        const sidebarClose = document.getElementById('sidebar-close');
        const sidebarOverlay = document.createElement('div');
        sidebarOverlay.className = 'sidebar-overlay';
        document.body.appendChild(sidebarOverlay);

        function openSidebar() {
            sidebar.classList.add('open');
            sidebarOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeSidebar() {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        mobileMenuToggle?.addEventListener('click', openSidebar);
        sidebarClose?.addEventListener('click', closeSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);

        // Close sidebar when clicking nav links on mobile
        document.querySelectorAll('.admin-nav-link').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    closeSidebar();
                }
            });
        });

        // Dark Mode Functionality
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const html = document.documentElement;

        // Check for saved dark mode preference, default to dark mode
        const savedTheme = localStorage.getItem('admin-theme');
        if (savedTheme !== 'light') {
            html.setAttribute('data-theme', 'dark');
            if (darkModeToggle) darkModeToggle.textContent = '‚òÄÔ∏è Light Mode';
        }

        darkModeToggle?.addEventListener('click', () => {
            const currentTheme = html.getAttribute('data-theme');

            if (currentTheme === 'dark') {
                html.removeAttribute('data-theme');
                localStorage.setItem('admin-theme', 'light');
                darkModeToggle.textContent = 'üåô Dark Mode';
                AdminComponentsV2.toast({
                    type: 'info',
                    message: 'Light mode enabled',
                    duration: 2000
                });
            } else {
                html.setAttribute('data-theme', 'dark');
                localStorage.setItem('admin-theme', 'dark');
                darkModeToggle.textContent = '‚òÄÔ∏è Light Mode';
                AdminComponentsV2.toast({
                    type: 'info',
                    message: 'Dark mode enabled',
                    duration: 2000
                });
            }
        });
    </script>
</body>
</html>
