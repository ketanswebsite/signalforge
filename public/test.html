<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Test Dashboard - Stock Proxy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            padding: 30px;
        }

        .test-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border-left: 5px solid #3498db;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .test-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-item {
            background: white;
            margin: 15px 0;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #ddd;
            transition: all 0.3s ease;
        }

        .test-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .test-item h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .test-item p {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .test-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9rem;
        }

        .btn-test {
            background: #3498db;
            color: white;
        }

        .btn-test:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .btn-view {
            background: #27ae60;
            color: white;
        }

        .btn-view:hover {
            background: #229954;
            transform: translateY(-1px);
        }

        .btn-check {
            background: #f39c12;
            color: white;
        }

        .btn-check:hover {
            background: #e67e22;
            transform: translateY(-1px);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-unknown { background: #95a5a6; }
        .status-working { background: #27ae60; }
        .status-warning { background: #f39c12; }
        .status-error { background: #e74c3c; }

        .result-area {
            background: #ecf0f1;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .result-area.show {
            display: block;
        }

        .system-overview {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            grid-column: 1 / -1;
        }

        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .overview-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .overview-item h4 {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .overview-item .status {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }

        .critical { border-left-color: #e74c3c; }
        .warning { border-left-color: #f39c12; }
        .success { border-left-color: #27ae60; }
        .info { border-left-color: #3498db; }

        @media (max-width: 768px) {
            .test-grid {
                grid-template-columns: 1fr;
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .test-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ System Test Dashboard</h1>
            <p>Comprehensive testing interface for Stock Proxy application</p>
        </div>

        <div class="test-grid">
            <!-- System Overview -->
            <div class="system-overview">
                <h2>üìä System Status Overview</h2>
                <div class="overview-grid">
                    <div class="overview-item">
                        <div class="status" id="db-status">‚ùì</div>
                        <h4>Database</h4>
                        <small id="db-details">Testing...</small>
                    </div>
                    <div class="overview-item">
                        <div class="status" id="auth-status">‚ùì</div>
                        <h4>Authentication</h4>
                        <small id="auth-details">Testing...</small>
                    </div>
                    <div class="overview-item">
                        <div class="status" id="api-status">‚ùì</div>
                        <h4>API Endpoints</h4>
                        <small id="api-details">Testing...</small>
                    </div>
                    <div class="overview-item">
                        <div class="status" id="ml-status">‚ùì</div>
                        <h4>ML Features</h4>
                        <small id="ml-details">Testing...</small>
                    </div>
                </div>
            </div>

            <!-- Core Functionality Tests -->
            <div class="test-section critical">
                <h2><span class="icon">üîß</span>Core System Tests</h2>
                
                <div class="test-item">
                    <h3><span class="status-indicator status-unknown"></span>Database Connection</h3>
                    <p>Test PostgreSQL database connectivity and basic operations</p>
                    <div class="test-actions">
                        <button class="btn btn-test" onclick="testDatabase()">Test Connection</button>
                        <button class="btn btn-check" onclick="checkTables()">Check Tables</button>
                    </div>
                    <div class="result-area" id="db-result"></div>
                </div>

                <div class="test-item">
                    <h3><span class="status-indicator status-unknown"></span>API Health Check</h3>
                    <p>Verify all API endpoints are responding correctly</p>
                    <div class="test-actions">
                        <button class="btn btn-test" onclick="testAPIHealth()">Test APIs</button>
                        <button class="btn btn-view" onclick="viewAPIList()">View Endpoints</button>
                    </div>
                    <div class="result-area" id="api-result"></div>
                </div>

                <div class="test-item">
                    <h3><span class="status-indicator status-unknown"></span>Session Management</h3>
                    <p>Test session creation and memory store functionality</p>
                    <div class="test-actions">
                        <button class="btn btn-test" onclick="testSessions()">Test Sessions</button>
                    </div>
                    <div class="result-area" id="session-result"></div>
                </div>
            </div>

            <!-- Authentication Tests -->
            <div class="test-section warning">
                <h2><span class="icon">üîê</span>Authentication Tests</h2>
                
                <div class="test-item">
                    <h3><span class="status-indicator status-unknown"></span>Login System</h3>
                    <p>Test Google OAuth login functionality</p>
                    <div class="test-actions">
                        <a href="/login.html" class="btn btn-view">Go to Login</a>
                        <button class="btn btn-test" onclick="testAuthStatus()">Check Auth Status</button>
                    </div>
                    <div class="result-area" id="auth-result"></div>
                </div>

                <div class="test-item">
                    <h3><span class="status-indicator status-unknown"></span>Protected Routes</h3>
                    <p>Verify route protection and access controls</p>
                    <div class="test-actions">
                        <button class="btn btn-test" onclick="testProtectedRoutes()">Test Routes</button>
                    </div>
                    <div class="result-area" id="protected-result"></div>
                </div>
            </div>

            <!-- Trade Management Tests -->
            <div class="test-section success">
                <h2><span class="icon">üìà</span>Trade Management Tests</h2>
                
                <div class="test-item">
                    <h3><span class="status-indicator status-unknown"></span>Trade Operations</h3>
                    <p>Test adding, viewing, and managing trades</p>
                    <div class="test-actions">
                        <a href="/trades.html" class="btn btn-view">Open Trades</a>
                        <button class="btn btn-test" onclick="testTradeOperations()">Test Operations</button>
                    </div>
                    <div class="result-area" id="trade-result"></div>
                </div>

                <div class="test-item">
                    <h3><span class="status-indicator status-unknown"></span>Data Persistence</h3>
                    <p>Verify trades are properly saved to PostgreSQL</p>
                    <div class="test-actions">
                        <button class="btn btn-test" onclick="testDataPersistence()">Test Persistence</button>
                        <a href="/data-management.html" class="btn btn-view">Data Management</a>
                    </div>
                    <div class="result-area" id="persistence-result"></div>
                </div>
            </div>

            <!-- Subscription & ML Tests -->
            <div class="test-section info">
                <h2><span class="icon">ü§ñ</span>Advanced Features</h2>
                
                <div class="test-item">
                    <h3><span class="status-indicator status-unknown"></span>Subscription System</h3>
                    <p>Test subscription middleware and plan management</p>
                    <div class="test-actions">
                        <button class="btn btn-test" onclick="testSubscription()">Test Subscription</button>
                    </div>
                    <div class="result-area" id="subscription-result"></div>
                </div>

                <div class="test-item">
                    <h3><span class="status-indicator status-unknown"></span>ML Integration</h3>
                    <p>Test machine learning features and AI models</p>
                    <div class="test-actions">
                        <button class="btn btn-test" onclick="testMLFeatures()">Test ML</button>
                    </div>
                    <div class="result-area" id="ml-result"></div>
                </div>

                <div class="test-item">
                    <h3><span class="status-indicator status-unknown"></span>Alert System</h3>
                    <p>Test Telegram bot and alert functionality</p>
                    <div class="test-actions">
                        <a href="/alerts.html" class="btn btn-view">View Alerts</a>
                        <button class="btn btn-test" onclick="testAlerts()">Test Alerts</button>
                    </div>
                    <div class="result-area" id="alert-result"></div>
                </div>

                <div class="test-item">
                    <h3><span class="status-indicator status-unknown"></span>7 AM Scan Test</h3>
                    <p>Test the scheduled 7 AM UK time stock scan (simulates cron job execution)</p>
                    <div class="test-actions">
                        <button class="btn btn-test" onclick="test7AMScan()">Test 7 AM Scan</button>
                        <button class="btn btn-check" onclick="checkScannerStatus()">Check Scanner Status</button>
                    </div>
                    <div class="result-area" id="scan-test-result"></div>
                </div>
            </div>

            <!-- User Analytics -->
            <div class="test-section success">
                <h2><span class="icon">üë•</span>User Analytics</h2>
                
                <div class="test-item">
                    <h3><span class="status-indicator status-unknown"></span>Google OAuth Users</h3>
                    <p>Track how many users have signed up and logged in via Google OAuth</p>
                    <div class="test-actions">
                        <button class="btn btn-test" onclick="getUserAnalytics()">Get User Stats</button>
                        <button class="btn btn-test" onclick="refreshUserStats()">Refresh</button>
                        <button class="btn btn-check" onclick="debugUsersTable()">Debug Users Table</button>
                        <button class="btn btn-view" onclick="recoverMissingUsers()">Recover Missing Users</button>
                    </div>
                    <div class="result-area" id="user-analytics-result"></div>
                </div>

                <div class="test-item">
                    <h3><span class="status-indicator status-unknown"></span>User Engagement</h3>
                    <p>See breakdown of users who have taken trades vs those who just signed up</p>
                    <div class="test-actions">
                        <button class="btn btn-view" onclick="showEngagementDetails()">View Details</button>
                    </div>
                    <div class="result-area" id="engagement-result"></div>
                </div>
            </div>

            <!-- Navigation & UI Tests -->
            <div class="test-section info">
                <h2><span class="icon">üåê</span>Application Pages</h2>
                
                <div class="test-item">
                    <h3><span class="status-indicator status-unknown"></span>Core Pages</h3>
                    <p>Test all main application pages and navigation</p>
                    <div class="test-actions">
                        <a href="/index.html" class="btn btn-view">Home</a>
                        <a href="/trades.html" class="btn btn-view">Trades</a>
                        <a href="/alerts.html" class="btn btn-view">Alerts</a>
                        <a href="/data-management.html" class="btn btn-view">Data</a>
                    </div>
                </div>

                <div class="test-item">
                    <h3><span class="status-indicator status-unknown"></span>Legal Pages</h3>
                    <p>Verify privacy policy and terms of service</p>
                    <div class="test-actions">
                        <a href="/privacy.html" class="btn btn-view">Privacy Policy</a>
                        <a href="/terms.html" class="btn btn-view">Terms of Service</a>
                    </div>
                </div>
            </div>

            <!-- Performance Tests -->
            <div class="test-section warning">
                <h2><span class="icon">‚ö°</span>Performance Tests</h2>
                
                <div class="test-item">
                    <h3><span class="status-indicator status-unknown"></span>Load Testing</h3>
                    <p>Test application performance and response times</p>
                    <div class="test-actions">
                        <button class="btn btn-test" onclick="testPerformance()">Test Performance</button>
                    </div>
                    <div class="result-area" id="performance-result"></div>
                </div>

                <div class="test-item">
                    <h3><span class="status-indicator status-unknown"></span>Memory Usage</h3>
                    <p>Check session memory store and potential issues</p>
                    <div class="test-actions">
                        <button class="btn btn-test" onclick="testMemoryUsage()">Check Memory</button>
                    </div>
                    <div class="result-area" id="memory-result"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Auto-run basic tests on page load
        document.addEventListener('DOMContentLoaded', function() {
            runBasicTests();
        });

        async function runBasicTests() {
            await testAPIHealth();
            await testDatabase();
            await testAuthStatus();
        }

        function showResult(elementId, content, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            element.classList.add('show');
            element.style.background = isError ? '#ffe6e6' : '#e6f7ff';
            element.style.color = isError ? '#d63031' : '#0984e3';
        }

        function updateStatus(elementId, status, details = '') {
            const statusElement = document.getElementById(elementId);
            const detailsElement = document.getElementById(elementId.replace('-status', '-details'));
            
            const statusMap = {
                'working': '‚úÖ',
                'warning': '‚ö†Ô∏è',
                'error': '‚ùå',
                'unknown': '‚ùì'
            };
            
            if (statusElement) statusElement.textContent = statusMap[status] || '‚ùì';
            if (detailsElement) detailsElement.textContent = details;
        }

        async function testDatabase() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                if (response.ok) {
                    showResult('db-result', `‚úÖ Database connection successful\nResponse: ${JSON.stringify(data, null, 2)}`);
                    updateStatus('db-status', 'working', 'PostgreSQL Connected');
                } else {
                    throw new Error(`HTTP ${response.status}: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                showResult('db-result', `‚ùå Database test failed\nError: ${error.message}`, true);
                updateStatus('db-status', 'error', 'Connection Failed');
            }
        }

        async function testAPIHealth() {
            const endpoints = [
                '/health',
                '/api/trades',
                '/api/user'
            ];
            
            let results = 'üîç Testing API endpoints...\n\n';
            let allWorking = true;
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint);
                    const status = response.ok ? '‚úÖ' : '‚ö†Ô∏è';
                    results += `${status} ${endpoint}: ${response.status} ${response.statusText}\n`;
                    if (!response.ok) allWorking = false;
                } catch (error) {
                    results += `‚ùå ${endpoint}: ${error.message}\n`;
                    allWorking = false;
                }
            }
            
            showResult('api-result', results);
            updateStatus('api-status', allWorking ? 'working' : 'warning', allWorking ? 'All APIs Working' : 'Some Issues');
        }

        async function testAuthStatus() {
            try {
                const response = await fetch('/api/user');
                const data = await response.json();
                
                if (response.ok && data.user) {
                    showResult('auth-result', `‚úÖ User authenticated\nUser: ${data.user.email}\nName: ${data.user.name}`);
                    updateStatus('auth-status', 'working', 'Authenticated');
                } else {
                    showResult('auth-result', `‚ÑπÔ∏è Not authenticated\nStatus: ${response.status}\nPlease log in to test full functionality`);
                    updateStatus('auth-status', 'warning', 'Not Logged In');
                }
            } catch (error) {
                showResult('auth-result', `‚ùå Auth test failed\nError: ${error.message}`, true);
                updateStatus('auth-status', 'error', 'Auth System Error');
            }
        }

        async function testTradeOperations() {
            try {
                const response = await fetch('/api/trades');
                const data = await response.json();
                
                if (response.ok) {
                    showResult('trade-result', `‚úÖ Trade operations working\nTotal trades: ${data.totalTrades || 0}\nDatabase: ${data.database || 'PostgreSQL'}`);
                } else {
                    throw new Error(`HTTP ${response.status}: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                showResult('trade-result', `‚ùå Trade operations failed\nError: ${error.message}`, true);
            }
        }

        async function testMLFeatures() {
            try {
                const response = await fetch('/api/ml/analysis/AAPL');
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('ml-result', `‚úÖ ML features accessible\nResponse: ${JSON.stringify(data, null, 2)}`);
                    updateStatus('ml-status', 'working', 'ML Models Active');
                } else {
                    showResult('ml-result', `‚ö†Ô∏è ML endpoint responded with status ${response.status}`, true);
                    updateStatus('ml-status', 'warning', 'Limited Access');
                }
            } catch (error) {
                showResult('ml-result', `‚ùå ML features test failed\nError: ${error.message}`, true);
                updateStatus('ml-status', 'error', 'ML System Error');
            }
        }

        async function testSubscription() {
            try {
                const response = await fetch('/api/check-subscription-setup');
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('subscription-result', `‚úÖ Subscription system working\nResponse: ${JSON.stringify(data, null, 2)}`);
                } else {
                    showResult('subscription-result', `‚ö†Ô∏è Subscription endpoint status: ${response.status}`);
                }
            } catch (error) {
                showResult('subscription-result', `‚ùå Subscription test failed\nError: ${error.message}`, true);
            }
        }

        async function testAlerts() {
            showResult('alert-result', `‚ÑπÔ∏è Alert system test\nTelegram bot should be configured and running based on deployment logs.\nCheck server logs for bot status.`);
        }

        async function test7AMScan() {
            try {
                showResult('scan-test-result', 'üîÑ Triggering 7 AM scan test...\n\nThis will simulate the exact same logic that runs at 7 AM UK time daily.');
                
                const response = await fetch('/api/test-7am-scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('scan-test-result', `‚úÖ 7 AM Scan Test Triggered!\n\n${data.message}\n\nCheck your Telegram for the scan results.\n\nNote: This uses the same logic as the automated 7 AM scan.`);
                } else if (response.status === 401) {
                    showResult('scan-test-result', 'üîí Please log in to test the 7 AM scan', true);
                } else {
                    const error = await response.json();
                    showResult('scan-test-result', `‚ùå Scan test failed\nError: ${error.error || 'Unknown error'}`, true);
                }
            } catch (error) {
                showResult('scan-test-result', `‚ùå Failed to trigger scan test\nError: ${error.message}`, true);
            }
        }

        async function checkScannerStatus() {
            try {
                const response = await fetch('/api/scanner/status');
                
                if (response.ok) {
                    const data = await response.json();
                    const statusDisplay = `
üìä SCANNER STATUS

üîç Scanner State:
   ‚îú‚îÄ Is Scanning: ${data.isScanning ? '‚úÖ Yes' : '‚ùå No'}
   ‚îú‚îÄ Scheduled Jobs: ${data.scheduledJobs}
   ‚îî‚îÄ Last Results: ${data.lastResults ? data.lastResults.length + ' opportunities found' : 'No results yet'}

‚è∞ Schedule:
   ‚îî‚îÄ Daily scan at 7 AM UK time (Europe/London timezone)

üîß Configuration:
   ‚îî‚îÄ TELEGRAM_CHAT_ID: ${data.telegramConfigured ? '‚úÖ Configured' : '‚ùå Not configured'}

üí° Tips:
   ‚Ä¢ Use "Test 7 AM Scan" to simulate the daily scan
   ‚Ä¢ Check server logs for detailed scan information
   ‚Ä¢ Ensure TELEGRAM_CHAT_ID is set in environment variables
                    `;
                    showResult('scan-test-result', statusDisplay);
                } else if (response.status === 401) {
                    showResult('scan-test-result', 'üîí Please log in to check scanner status', true);
                } else {
                    showResult('scan-test-result', `‚ùå Failed to get scanner status\nStatus: ${response.status}`, true);
                }
            } catch (error) {
                showResult('scan-test-result', `‚ùå Error checking scanner status\nError: ${error.message}`, true);
            }
        }

        async function testSessions() {
            try {
                const response = await fetch('/api/session-test');
                showResult('session-result', `‚ÑπÔ∏è Session test\nMemory store is active (sessions won't persist across restarts)\nThis is expected behavior with current configuration.`);
            } catch (error) {
                showResult('session-result', `‚ö†Ô∏è Session test\nError: ${error.message}\nMemory store should still be working for current session.`);
            }
        }

        async function testProtectedRoutes() {
            const protectedRoutes = ['/api/trades', '/api/trades', '/api/user'];
            let results = 'üîê Testing protected routes...\n\n';
            
            for (const route of protectedRoutes) {
                try {
                    const response = await fetch(route);
                    const status = response.status === 401 ? '‚úÖ Protected' : response.ok ? '‚úÖ Accessible' : '‚ö†Ô∏è Issue';
                    results += `${status} ${route}: ${response.status}\n`;
                } catch (error) {
                    results += `‚ùå ${route}: ${error.message}\n`;
                }
            }
            
            showResult('protected-result', results);
        }

        async function testDataPersistence() {
            showResult('persistence-result', `‚ÑπÔ∏è Data persistence test\nAll data is now stored in PostgreSQL database.\nAdd a test trade and refresh to verify persistence.`);
        }

        async function testPerformance() {
            const startTime = performance.now();
            try {
                await fetch('/health');
                const endTime = performance.now();
                const responseTime = (endTime - startTime).toFixed(2);
                showResult('performance-result', `‚úÖ Performance test\nAPI response time: ${responseTime}ms\n${responseTime < 1000 ? 'Good' : responseTime < 3000 ? 'Acceptable' : 'Slow'} response time`);
            } catch (error) {
                showResult('performance-result', `‚ùå Performance test failed\nError: ${error.message}`, true);
            }
        }

        async function testMemoryUsage() {
            showResult('memory-result', `‚ö†Ô∏è Memory usage info\nCurrently using memory store for sessions.\nSessions will not persist across server restarts.\nConsider implementing PostgreSQL session store for production.`);
        }

        async function checkTables() {
            try {
                const response = await fetch('/api/check-subscription-setup');
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('db-result', `‚úÖ Database tables check\nResponse: ${JSON.stringify(data, null, 2)}`);
                } else {
                    showResult('db-result', `‚ö†Ô∏è Tables check status: ${response.status}\nMay require admin access`, true);
                }
            } catch (error) {
                showResult('db-result', `‚ùå Tables check failed\nError: ${error.message}`, true);
            }
        }

        async function viewAPIList() {
            const apiList = `
üìã Available API Endpoints:

üîµ Public Endpoints:
- GET /health - System health check

üîê Protected Endpoints (require authentication):
- GET /api/test - Basic API test
- GET /api/trades - Get user trades
- POST /api/trades - Add new trade
- GET /api/user - Get user profile
- GET /api/user-analytics - User statistics and analytics
- GET /api/check-subscription-setup - Subscription status

ü§ñ ML Endpoints:
- GET /api/ml/models/status - ML models status
- POST /api/ml/analyze - Analyze trades

üëë Admin Endpoints:
- GET /api/admin/check-tables - Check database tables
- GET /api/admin/raw-trades - Raw trade data

üîî Alert Endpoints:
- GET /api/alerts - Get alerts
- POST /api/alerts - Create alert
            `;
            showResult('api-result', apiList);
        }

        // User Analytics Functions
        async function getUserAnalytics() {
            try {
                const response = await fetch('/api/user-analytics');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    const analyticsDisplay = `
üìä USER ANALYTICS DASHBOARD

üë• Total Registered Users: ${data.totalUsers}
   ‚îú‚îÄ Users with Trades: ${data.usersWithTrades}
   ‚îî‚îÄ Users without Trades: ${data.usersWithoutTrades}

üìà Trading Activity:
   ‚îú‚îÄ Total Trades: ${data.systemInfo.totalTrades}
   ‚îú‚îÄ Active Trades: ${data.systemInfo.activeTrades}
   ‚îî‚îÄ Closed Trades: ${data.systemInfo.closedTrades}

üìÖ Last Updated: ${new Date(data.lastUpdated).toLocaleString()}

üí° User Engagement Rate: ${data.totalUsers > 0 ? Math.round((data.usersWithTrades / data.totalUsers) * 100) : 0}%
   (Percentage of users who have made at least one trade)
                    `;
                    
                    showResult('user-analytics-result', analyticsDisplay);
                    
                    // Update engagement details automatically
                    showEngagementDetails(data);
                    
                } else if (response.status === 401) {
                    showResult('user-analytics-result', 'üîí Please log in to view user analytics', true);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                showResult('user-analytics-result', `‚ùå Failed to fetch user analytics\nError: ${error.message}`, true);
            }
        }

        async function refreshUserStats() {
            showResult('user-analytics-result', 'üîÑ Refreshing user statistics...');
            await getUserAnalytics();
        }

        function showEngagementDetails(data = null) {
            if (!data) {
                showResult('engagement-result', 'üìä Click "Get User Stats" first to load engagement data');
                return;
            }

            const engagementDetails = `
üìä USER ENGAGEMENT BREAKDOWN

üë§ User Categories:
   üéØ Active Traders: ${data.usersWithTrades} users
      ‚îî‚îÄ Users who have created at least one trade
   
   üëÅÔ∏è Browsers: ${data.usersWithoutTrades} users
      ‚îî‚îÄ Signed up but haven't made any trades yet

üìà Engagement Insights:
   ‚Ä¢ Conversion Rate: ${data.totalUsers > 0 ? Math.round((data.usersWithTrades / data.totalUsers) * 100) : 0}%
   ‚Ä¢ Average Trades per Active User: ${data.usersWithTrades > 0 ? Math.round(data.systemInfo.totalTrades / data.usersWithTrades) : 0}
   
üí° Growth Opportunities:
   ${data.usersWithoutTrades > 0 ? 
     `‚Ä¢ ${data.usersWithoutTrades} users could be encouraged to make their first trade
   ‚Ä¢ Consider onboarding improvements or tutorials` : 
     '‚Ä¢ All registered users are actively trading! üéâ'}

üîÑ Live Data: All statistics reflect current database state
            `;
            
            showResult('engagement-result', engagementDetails);
        }

        // Debug function to check users table directly
        async function debugUsersTable() {
            try {
                const response = await fetch('/api/debug/users');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    let debugDisplay = `
üîç USERS TABLE DEBUG INFORMATION

üìä Direct Table Query Results:
   ‚îî‚îÄ Total Users in Table: ${data.totalUsersInTable}

üë§ Users Found (ordered by last login):
`;
                    
                    if (data.users && data.users.length > 0) {
                        data.users.forEach((user, index) => {
                            debugDisplay += `
   ${index + 1}. ${user.email}
      ‚îú‚îÄ Name: ${user.name || 'N/A'}
      ‚îú‚îÄ First Login: ${user.first_login ? new Date(user.first_login).toLocaleString() : 'N/A'}
      ‚îî‚îÄ Last Login: ${user.last_login ? new Date(user.last_login).toLocaleString() : 'N/A'}
`;
                        });
                    } else {
                        debugDisplay += `
   ‚ùå No users found in table!
   
üîß Possible Issues:
   ‚Ä¢ Users table might not be created
   ‚Ä¢ saveOrUpdateUser function not being called during login
   ‚Ä¢ Database migration not completed
   ‚Ä¢ Users logged in before users table was created
`;
                    }
                    
                    debugDisplay += `

üîß Debug Info:
   ‚îú‚îÄ Table Exists: ${data.debugInfo.tableExists}
   ‚îú‚îÄ Query Executed: ${data.debugInfo.queryExecuted}
   ‚îî‚îÄ Current User: ${data.currentUser}

üí° If you see fewer users than expected:
   1. Users might have logged in before the users table was created
   2. Check server logs for saveOrUpdateUser errors
   3. The migration function might need to be triggered
   4. Previous logins with memory sessions were lost on restart
                    `;
                    
                    showResult('user-analytics-result', debugDisplay);
                    
                } else if (response.status === 401) {
                    showResult('user-analytics-result', 'üîí Please log in to access debug information', true);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                showResult('user-analytics-result', `‚ùå Debug failed\nError: ${error.message}\n\nThis could indicate the users table doesn't exist or there's a database connection issue.`, true);
            }
        }

        // User recovery function
        async function recoverMissingUsers() {
            try {
                showResult('user-analytics-result', 'üîÑ Searching for missing users and recovering them...');
                
                const response = await fetch('/api/recover-users');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    let recoveryDisplay = `
üîß USER RECOVERY COMPLETED

üìä Recovery Results:
   ‚îú‚îÄ Users Recovered: ${data.totalRecovered}
   ‚îú‚îÄ New Total Users: ${data.newTotalUsers}
   ‚îî‚îÄ Executed By: ${data.executedBy}

üë§ Recovered Users:
`;
                    
                    if (data.recoveredUsers && data.recoveredUsers.length > 0) {
                        data.recoveredUsers.forEach((user, index) => {
                            recoveryDisplay += `
   ${index + 1}. ${user.email}
      ‚îú‚îÄ First Trade: ${new Date(user.firstTradeDate).toLocaleDateString()}
      ‚îú‚îÄ Last Trade: ${new Date(user.lastTradeDate).toLocaleDateString()}
      ‚îî‚îÄ Total Trades: ${user.tradeCount}
`;
                        });
                    } else {
                        recoveryDisplay += `
   ‚úÖ No missing users found - all users are properly tracked!
`;
                    }
                    
                    if (data.errors && data.errors.length > 0) {
                        recoveryDisplay += `
‚ö†Ô∏è Errors During Recovery:
`;
                        data.errors.forEach((error, index) => {
                            recoveryDisplay += `   ${index + 1}. ${error.email}: ${error.error}\n`;
                        });
                    }
                    
                    recoveryDisplay += `

‚úÖ PERMANENT SOLUTION IMPLEMENTED:
   ‚Ä¢ Auto-recovery runs on every server startup
   ‚Ä¢ Missing users are automatically found and added
   ‚Ä¢ Users are tracked from their first trade onwards
   ‚Ä¢ No more missing user issues going forward!

üîÑ Refresh user stats to see the updated totals.
                    `;
                    
                    showResult('user-analytics-result', recoveryDisplay);
                    
                } else if (response.status === 401) {
                    showResult('user-analytics-result', 'üîí Please log in to access user recovery', true);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                showResult('user-analytics-result', `‚ùå User recovery failed\nError: ${error.message}`, true);
            }
        }
    </script>
</body>
</html>